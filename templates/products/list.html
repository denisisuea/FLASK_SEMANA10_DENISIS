{% extends "base.html" %}

{% block title %}Inventario de Productos{% endblock %}

{% block content %}
{% set _page = page|default(1, true) %}
{% set _per_page = per_page|default(5, true) %}
{% set _total = total|default(productos|length if productos is defined else 0, true) %}
{% set _last_page = last_page|default((_total + _per_page - 1) // _per_page if _total else 1, true) %}

<div class="page-section">
  <h1 class="mb-4">Inventario de Productos</h1>

  <!-- Formulario de búsqueda con selección de productos por página -->
  <form method="get" action="{{ url_for('listar_productos') }}" class="form-inline mb-3 d-flex gap-2 flex-wrap">
    <input type="text" name="q" placeholder="Buscar por nombre" value="{{ q or '' }}" class="form-control w-auto">

    <button type="submit" class="btn btn-primary">Buscar</button>
    <a class="btn btn-success" href="{{ url_for('crear_producto') }}">Nuevo</a>
  </form>

  {% if productos and productos|length > 0 %}
  <table class="table table-striped table-bordered text-center align-middle">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Cantidad</th>
        <th>Precio</th>
        <th>Descripción</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for p in productos %}
      <tr>
        <td>{{ p['id_producto'] }}</td>
        <td>{{ p['nombre'] }}</td>
        <td>{{ p['cantidad'] }}</td>
        <td>${{ (p['precio']|float)|round(2) }}</td>
        <td>{{ p['descripcion'] }}</td>
        <td class="d-flex justify-content-center gap-2 flex-wrap">
          <a class="btn btn-sm btn-primary" href="{{ url_for('editar_producto', id_producto=p['id_producto']) }}">
            <i class="fas fa-edit"></i> Editar
          </a>

          <form method="post" action="{{ url_for('eliminar_producto', id_producto=p['id_producto']) }}" onsubmit='return confirm("¿Eliminar {{ p["nombre"]|e }}?");'>
            <button type="submit" class="btn btn-sm btn-danger">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Resumen -->
  <p class="text-muted">
    Mostrando {{ (_page - 1) * _per_page + 1 }} – {{ (_page - 1) * _per_page + productos|length }} de {{ _total }}
  </p>

  <!-- Paginación -->
  <nav aria-label="Paginación">
    <ul class="pagination justify-content-center">

      <li class="page-item {% if _page == 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('listar_productos', page=_page-1, q=q, per_page=_per_page) }}">&laquo;</a>
      </li>

      {% set start_page = [1, _page-2]|max %}
      {% set end_page = [_last_page, _page+2]|min %}

      {% if start_page > 1 %}
        <li class="page-item"><a class="page-link" href="{{ url_for('listar_productos', page=1, q=q, per_page=_per_page) }}">1</a></li>
        {% if start_page > 2 %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
      {% endif %}

      {% for pnum in range(start_page, end_page + 1) %}
        <li class="page-item {% if pnum == _page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('listar_productos', page=pnum, q=q, per_page=_per_page) }}">{{ pnum }}</a>
        </li>
      {% endfor %}

      {% if end_page < _last_page %}
        {% if end_page < _last_page - 1 %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
        <li class="page-item"><a class="page-link" href="{{ url_for('listar_productos', page=_last_page, q=q, per_page=_per_page) }}">{{ _last_page }}</a></li>
      {% endif %}

      <li class="page-item {% if _page == _last_page %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('listar_productos', page=_page+1, q=q, per_page=_per_page) }}">&raquo;</a>
      </li>

    </ul>
  </nav>

  {% else %}
  <div class="alert alert-warning text-center mt-4">
    No hay productos para mostrar.
  </div>
  {% endif %}
</div>
{% endblock %}


